%% Client Architecture: Movement with Client-Side Prediction
%% Sequence diagram showing movement input, prediction, and rendering

sequenceDiagram
    participant User as User
    participant InputHandler as InputHandler
    participant NetworkedMode as Networked Mode
    participant Board as Board (adapter)
    participant Renderer as Renderer
    participant WSClient as WebSocketClient
    participant Server as Game Server
    
    Note over User,Server: Movement with Prediction Sequence
    
    User->>InputHandler: Press arrow key (e.g., Right)
    InputHandler->>InputHandler: Parse key sequence
    InputHandler->>InputHandler: Map to dx=1, dy=0
    InputHandler->>NetworkedMode: onMove callback (dx=1, dy=0)
    
    NetworkedMode->>NetworkedMode: validateMovement(dx, dy)
    NetworkedMode->>Board: Check bounds
    Board-->>NetworkedMode: Bounds valid
    NetworkedMode->>Board: Check walls
    Board-->>NetworkedMode: Not a wall
    NetworkedMode->>NetworkedMode: Check collisions
    NetworkedMode-->>NetworkedMode: Validation result
    
    alt Movement is valid
        NetworkedMode->>NetworkedMode: Calculate new position
        NetworkedMode->>NetworkedMode: newX = predicted.x + dx
        NetworkedMode->>NetworkedMode: newY = predicted.y + dy
        
        NetworkedMode->>NetworkedMode: Update prediction immediately
        NetworkedMode->>NetworkedMode: localPlayerPredictedPosition = {x: newX, y: newY}
        
        NetworkedMode->>Renderer: renderIncremental(changes, board, players)
        Renderer->>Renderer: Clear old position
        Renderer->>Renderer: Draw at new position
        Renderer-->>NetworkedMode: Render complete
        
        Note over NetworkedMode: User sees instant feedback
        
        NetworkedMode->>MessageHandler: createMessage(MOVE, {dx, dy})
        MessageHandler-->>NetworkedMode: MOVE message
        NetworkedMode->>WSClient: send(MOVE message)
        WSClient->>Server: MOVE message (JSON)
        
        Note over Server: Server validates and processes
        Note over Server: State will be broadcast in next cycle
    else Movement is invalid
        NetworkedMode->>NetworkedMode: Ignore movement
        Note over NetworkedMode: No prediction, no render
    end
