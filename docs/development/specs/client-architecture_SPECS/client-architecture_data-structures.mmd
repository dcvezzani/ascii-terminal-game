%% Client Architecture Data Structures Diagram
%% Shows internal data organization and relationships

classDiagram
    %% Networked Mode
    class NetworkedMode {
        -currentState: GameState
        -previousState: GameState | null
        -localPlayerId: string | null
        -localPlayerPredictedPosition: Position
        -remoteEntityBuffers: Map~playerId, BufferSnapshot[]~
        -remoteEntityInterpolated: Map~playerId, InterpolatedEntity~
        -lastDrawnInterpolatedPositions: Map~playerId, Position~
        -interpolationTickTimer: Timer | null
        -wsClient: WebSocketClient
        -renderer: Renderer
        -inputHandler: InputHandler
        -reconciliationTimer: Timer | null
        +start() Promise
        -handleConnect(message)
        -handleStateUpdate(message)
        -handleMove(dx, dy)
        -validateMovement(dx, dy) boolean
        -reconcilePosition()
        -getInterpolatedPosition(buffer, renderTime)
        -runInterpolationTick()
        -startInterpolationTick()
        -stopInterpolationTick()
        -render()
    }
    
    class GameState {
        +board: BoardState
        +players: Player[]
        +score: number
    }
    
    class BoardState {
        +width: number
        +height: number
        +grid: string[][]
    }
    
    class Player {
        +playerId: string
        +x: number
        +y: number
        +playerName: string
        +vx?: number
        +vy?: number
    }
    
    class BufferSnapshot {
        +t: number
        +x: number
        +y: number
        +playerName?: string
        +vx?: number
        +vy?: number
    }
    
    class InterpolatedEntity {
        +x: number
        +y: number
        +playerName?: string
    }
    
    class Position {
        +x: number | null
        +y: number | null
    }
    
    %% WebSocket Client
    class WebSocketClient {
        -url: string
        -ws: WebSocket | null
        -messageQueue: Message[]
        -reconnectAttempts: number
        +connect() Promise
        +send(message) boolean
        +close()
        -flushQueue()
        -queueMessage(message)
        +on(event, callback)
    }
    
    class Message {
        +type: string
        +payload: object
        +timestamp: number
        +clientId?: string
    }
    
    %% Canvas (in-memory display buffer)
    class Canvas {
        +grid: Cell[][]
        +config: object
        -emptyGrid: Cell[][]
        +renderTitle(titleString, layout)
        +renderBoard(board, players, layout)
        +renderStatusBar(score, position, width, height, layout)
        +updateCell(x, y, glyph, color)
        +restoreCellContent(x, y, board, players, entities) string
        +getCellContent(x, y, board, players) string
        +clearScreen()
        +clearContentRegion(region)
        +hasNoChanges(prevCanvas, currentCanvas) boolean
        +hasFewChanges(prevCanvas, currentCanvas) boolean
    }
    
    %% Renderer (writes canvas to terminal)
    class Renderer {
        -playerGlyph: string
        -spaceGlyph: string
        -wallGlyph: string
        -playerColor: Function
        +render(canvas)
        +renderFull(canvas)
        +renderIncremental(canvas)
        +clearScreen()
    }
    
    %% Input Handler
    class InputHandler {
        -moveCallbacks: Function[]
        -quitCallbacks: Function[]
        +onMove(callback)
        +onQuit(callback)
        +start()
        +stop()
        -handleInput(data)
        -parseKeySequence(data) object
    }
    
    %% State Comparison
    class StateComparison {
        +compareStates(previous, current) Changes
        -detectPlayerChanges(previous, current) Changes
        -detectScoreChange(previous, current) boolean
    }
    
    class Changes {
        +moved: PlayerChange[]
        +joined: Player[]
        +left: Player[]
        +scoreChanged: boolean
    }
    
    class PlayerChange {
        +player: Player
        +oldX: number
        +oldY: number
        +newX: number
        +newY: number
    }
    
    %% Configuration
    class ClientConfig {
        +websocket: WebSocketConfig
        +logging: LoggingConfig
        +rendering: RenderingConfig
        +prediction: PredictionConfig
    }
    
    class WebSocketConfig {
        +url: string
    }
    
    class RenderingConfig {
        +playerGlyph: string
        +spaceGlyph: string
        +wallGlyph: string
        +playerColor: string
        +remoteDisplayEasing: boolean
    }
    
    class PredictionConfig {
        +enabled: boolean
        +reconciliationInterval: number
    }
    
    %% Relationships
    NetworkedMode "1" *-- "1" GameState : currentState
    NetworkedMode "1" *-- "0..1" GameState : previousState
    NetworkedMode "1" *-- "1" Position : localPlayerPredictedPosition
    NetworkedMode "1" *-- "*" BufferSnapshot : remoteEntityBuffers
    NetworkedMode "1" *-- "*" InterpolatedEntity : remoteEntityInterpolated
    NetworkedMode "1" *-- "*" Position : lastDrawnInterpolatedPositions
    NetworkedMode "1" *-- "1" Canvas : owns
    NetworkedMode *-- WebSocketClient : uses
    NetworkedMode *-- Renderer : uses
    NetworkedMode *-- InputHandler : uses
    NetworkedMode *-- StateComparison : uses
    
    Renderer ..> Canvas : "renders from"
    
    GameState "1" *-- "1" BoardState : contains
    GameState "1" *-- "*" Player : contains
    
    WebSocketClient "1" *-- "*" Message : queues
    
    StateComparison --> Changes : creates
    Changes "1" *-- "*" PlayerChange : contains
    
    NetworkedMode --> ClientConfig : uses
    ClientConfig "1" *-- "1" WebSocketConfig : contains
    ClientConfig "1" *-- "1" RenderingConfig : contains
    ClientConfig "1" *-- "1" PredictionConfig : contains
    
    %% Notes
    note for NetworkedMode "Manages game state and\ncoordinates all components"
    note for WebSocketClient "Handles connection and\nmessage queueing"
    note for Canvas "In-memory display buffer\nbuilt by NetworkedMode"
    note for Renderer "Writes canvas grid to\nterminal stdout"
    note for StateComparison "Detects changes between\nstate snapshots"
