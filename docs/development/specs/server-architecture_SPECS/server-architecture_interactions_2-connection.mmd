%% Server Architecture: Client Connection Flow
%% Sequence diagram showing client connection and player join

sequenceDiagram
    participant Client as WebSocket Client
    participant WSS as WebSocketServer
    participant Server as Server
    participant CM as ConnectionManager
    participant MH as MessageHandler
    participant MT as MessageTypes
    participant GS as GameServer
    participant Game as Game
    
    Note over Client,Game: Client Connection Sequence
    
    Client->>WSS: WebSocket connection
    WSS->>Server: 'connection' event (ws)
    
    Server->>Server: randomUUID() → clientId
    Server->>CM: addConnection(clientId, ws)
    CM->>CM: Store connection in Map
    
    Note over Client: Client sends CONNECT message
    
    Client->>WSS: CONNECT message (JSON)
    WSS->>Server: 'message' event (data)
    
    Server->>MH: parseMessage(data.toString())
    MH->>MH: JSON.parse() & validate
    MH-->>Server: Parsed message object
    
    Server->>Server: handleConnect(clientId, message)
    Server->>Server: randomUUID() → playerId
    Server->>GS: addPlayer(clientId, playerId, name)
    GS->>GS: Store player in Map
    Server->>GS: spawnPlayer(playerId, name)
    GS->>GS: Set player position (10, 10)
    Server->>CM: setPlayerId(clientId, playerId)
    
    Server->>GS: serializeState()
    GS->>Game: Access game.board & game.score
    GS->>GS: Get all players
    GS-->>Server: Serialized game state
    
    Server->>MH: createMessage(CONNECT, payload)
    MH->>MH: Add timestamp
    MH-->>Server: Message object
    
    Server->>CM: getConnection(clientId)
    CM-->>Server: Connection object
    Server->>Client: Send CONNECT response (JSON)
    
    Note over Client: Client receives full game state
